name: CI/CD Pipeline - Trabalho GC

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout do código
      uses: actions/checkout@v4

    - name: Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Instalar Dependências (para testes)
      run: |
        cd backend
        npm install

    - name: Rodar Testes Unitários
      run: |
        cd backend
        npm test 


    - name: Gerar arquivo .env com os Segredos Reais
      run: |
        touch .env
        echo "SMTP_HOST=${{ secrets.SMTP_HOST }}" >> .env
        echo "SMTP_USER=${{ secrets.SMTP_USER }}" >> .env
        echo "SMTP_PASS=${{ secrets.SMTP_PASS }}" >> .env
        
        echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}" >> .env
        echo "POSTGRES_USER=${{ secrets.POSTGRES_USER }}" >> .env
        echo "POSTGRES_DB=${{ secrets.POSTGRES_DB }}" >> .env

    - name: Login no Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build e Push da Imagem Backend
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        file: ./backend/Dockerfile
        push: true
        tags: ${{ secrets.DOCKER_USERNAME }}/projeto-backend:latest

    - name: Subir ambiente (Validar Docker Compose)
      run: docker compose up -d

    - name: Verificar Containers Rodando
      run: docker ps -a

    - name: Parar Containers
      if: always()
      run: docker compose down

    - name: Deploy Automático no Render
      if: github.ref == 'refs/heads/main' && success()
      run: |
        curl "${{ secrets.RENDER_DEPLOY_HOOK_FRONT }}"
        curl "${{ secrets.RENDER_DEPLOY_HOOK_BACK }}"